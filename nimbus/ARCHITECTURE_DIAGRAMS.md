# Nimbus Architecture Diagrams

## Current Architecture (v1.0)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              NIMBUS GATEWAY                                 │
│                            (Single Process)                                 │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                          HTTP Server (Chi)                             │ │
│  │                            Port 8080                                   │ │
│  │                                                                        │ │
│  │   Middleware: RequestID, RealIP, Recoverer, Timeout(30s), Logging      │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                     │                                       │
│                                     ▼                                       │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                           API Handlers                                 │ │
│  │                                                                        │ │
│  │   Notifications:                           Dead Letter Queue:          │ │
│  │   ├─ POST /v1/notifications                ├─ GET  /v1/dlq             │ │
│  │   ├─ GET  /v1/notifications                ├─ GET  /v1/dlq/{id}        │ │
│  │   ├─ GET  /v1/notifications/{id}           ├─ POST /v1/dlq/{id}/retry  │ │
│  │   └─ PATCH /v1/notifications/{id}/status   └─ POST /v1/dlq/{id}/discard│ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                     │                                       │
│                                     ▼                                       │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                        Repository Layer                                │ │
│  │                   (Interface-based abstraction)                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                     │                                       │
│          ┌──────────────────────────┴───────────────────────────┐           │
│          │                                                      │           │
│          ▼                                                      ▼           │
│   ┌─────────────────┐                                  ┌─────────────────┐  │
│   │  notifications  │                                  │  dead_letter_   │  │
│   │     table       │                                  │  notifications  │  │
│   │                 │                                  │                 │  │
│   │ - id            │                                  │ - id            │  │
│   │ - tenant_id     │◀─────── original_notification_id │ - tenant_id     │  │
│   │ - user_id       │                                  │ - attempts      │  │
│   │ - channel       │                                  │ - last_error    │  │
│   │ - payload       │                                  │ - status        │  │
│   │ - status        │                                  │   (pending/     │  │
│   │ - attempt       │                                  │    retried/     │  │
│   │ - next_retry_at │                                  │    discarded)   │  │
│   └─────────────────┘                                  └─────────────────┘  │
│                                                                             │
└──────────────────────────────────────┬──────────────────────────────────────┘
                                       │
                                       │ Same Process (goroutine)
                                       │
┌──────────────────────────────────────▼───────────────────────────────────────┐
│                            BACKGROUND WORKER                                 │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐    │
│   │                         Poll Loop (5s interval)                     │    │
│   │                                                                     │    │
│   │   for {                                                             │    │
│   │       notifications := repo.GetPendingNotifications(limit: 10)      │    │
│   │       for _, n := range notifications {                             │    │
│   │           processNotification(n)                                    │    │
│   │       }                                                             │    │
│   │       time.Sleep(5 * time.Second)                                   │    │
│   │   }                                                                 │    │
│   └─────────────────────────────────────────────────────────────────────┘    │
│                                      │                                       │
│                                      ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐    │
│   │                    processNotification(notif)                       │    │
│   │                                                                     │    │
│   │   1. Mark as "processing"                                           │    │
│   │   2. sender.Send(notif)                                             │    │
│   │   3. If success → status = "sent"                                   │    │
│   │      If failure:                                                    │    │
│   │        - attempt < maxRetries → status = "pending" + backoff        │    │
│   │        - attempt >= maxRetries → MoveToDeadLetter()                 │    │
│   └─────────────────────────────────────────────────────────────────────┘    │
│                                      │                                       │
│                                      ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐    │
│   │                          SES Sender                                 │    │
│   │                        (AWS SDK v2)                                 │    │
│   └─────────────────────────────────────────────────────────────────────┘    │
│                                      │                                       │
└──────────────────────────────────────┼───────────────────────────────────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │      AWS SES        │
                            │   (Email Delivery)  │
                            └─────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                               EXTERNAL                                      │
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                         PostgreSQL 15                             │     │
│   │                                                                   │     │
│   │   Database: nimbus                                                │     │
│   │   Tables: notifications, dead_letter_notifications                │     │
│   │   Connection: pgxpool (10 min, 4 max connections)                 │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Current Data Flow

```
                    API Request                          Background Worker
                         │                                      │
    ┌────────────────────▼─────────────────────┐                │
    │          POST /v1/notifications          │                │
    │                                          │                │
    │  {                                       │                │
    │    "tenant_id": "uuid",                  │                │
    │    "user_id": "uuid",                    │                │
    │    "channel": "email",                   │                │
    │    "payload": {"to": "...", ...}         │                │
    │  }                                       │                │
    └────────────────────┬─────────────────────┘                │
                         │                                      │
                         ▼                                      │
                  ┌─────────────┐                               │
                  │  Validate   │                               │
                  │  - UUIDs    │                               │
                  │  - channel  │                               │
                  │  - payload  │                               │
                  └──────┬──────┘                               │
                         │                                      │
                         ▼                                      │
    ┌─────────────────────────────────────────┐                 │
    │              PostgreSQL                 │◀────────────────┤
    │                                         │    Poll every   │
    │  INSERT INTO notifications              │     5 seconds   │
    │  (id, tenant_id, ..., status='pending') │                 │
    └────────────────────┬────────────────────┘                 │
                         │                                      │
                         ▼                                      ▼
                  ┌─────────────┐                        ┌─────────────┐
                  │ Return 201  │                        │   Worker    │
                  │   + UUID    │                        │  picks up   │
                  └─────────────┘                        │  pending    │
                                                         └──────┬──────┘
                                                                │
                                                                ▼
                                                  ┌─────────────────────────┐
                                                  │ Mark as "processing"    │
                                                  └────────────┬────────────┘
                                                               │
                                                               ▼
                                                  ┌─────────────────────────┐
                                                  │     sender.Send()       │
                                                  │       AWS SES           │
                                                  └────────────┬────────────┘
                                                               │
                                          ┌────────────────────┴────────────────────┐
                                          │                                         │
                                          ▼                                         ▼
                                   ┌─────────────┐                           ┌─────────────┐
                                   │   SUCCESS   │                           │   FAILURE   │
                                   │             │                           │             │
                                   │ status =    │                           │ attempt++   │
                                   │   "sent"    │                           │             │
                                   └─────────────┘                           └──────┬──────┘
                                                                                    │
                                                            ┌───────────────────────┴───────────────────────┐
                                                            │                                               │
                                                            ▼                                               ▼
                                                   ┌─────────────────┐                             ┌─────────────────┐
                                                   │ attempt < max   │                             │ attempt >= max  │
                                                   │ (max = 5)       │                             │ (exhausted)     │
                                                   └────────┬────────┘                             └────────┬────────┘
                                                            │                                               │
                                                            ▼                                               ▼
                                                   ┌─────────────────┐                             ┌─────────────────┐
                                                   │ status="pending"│                             │ MoveToDeadLetter│
                                                   │ next_retry_at = │                             │                 │
                                                   │ now + backoff   │                             │ Transaction:    │
                                                   │                 │                             │ 1. Insert DLQ   │
                                                   │ backoff:        │                             │ 2. Update notif │
                                                   │ 2^attempt mins  │                             │    status =     │
                                                   └─────────────────┘                             │  "dead_lettered"│
                                                                                                   └─────────────────┘
```

---

## Future Architecture (Production-Ready)

```
                                         ┌──────────────────┐
                                         │   Route 53       │
                                         │   DNS            │
                                         └────────┬─────────┘
                                                  │
                                                  ▼
                                         ┌──────────────────┐
                                         │   CloudFront     │
                                         │   (CDN + WAF)    │
                                         └────────┬─────────┘
                                                  │
                                                  ▼
                                   ┌──────────────────────────┐
                                   │   Application Load       │
                                   │      Balancer            │
                                   │                          │
                                   │   Health: /health        │
                                   │   SSL Termination        │
                                   └──────────────────────────┘
                                                  │
                 ┌────────────────────────────────┼────────────────────────────────┐
                 │                                │                                │
                 ▼                                ▼                                ▼
┌──────────────────────────┐    ┌──────────────────────────┐    ┌──────────────────────────┐
│    API Pod 1             │    │    API Pod 2             │    │    API Pod N             │
│    (ECS/EKS)             │    │    (ECS/EKS)             │    │    (ECS/EKS)             │
│                          │    │                          │    │                          │
│  ┌────────────────────┐  │    │  ┌────────────────────┐  │    │  ┌────────────────────┐  │
│  │  Rate Limiter      │  │    │  │  Rate Limiter      │  │    │  │  Rate Limiter      │  │
│  │  (Redis-backed)    │  │    │  │  (Redis-backed)    │  │    │  │  (Redis-backed)    │  │
│  │  100 req/min/key   │  │    │  │  100 req/min/key   │  │    │  │  100 req/min/key   │  │
│  └────────────────────┘  │    │  └────────────────────┘  │    │  └────────────────────┘  │
│  ┌────────────────────┐  │    │  ┌────────────────────┐  │    │  ┌────────────────────┐  │
│  │  Auth Middleware   │  │    │  │  Auth Middleware   │  │    │  │  Auth Middleware   │  │
│  │  - API Key header  │  │    │  │  - API Key header  │  │    │  │  - API Key header  │  │
│  │  - JWT Bearer      │  │    │  │  - JWT Bearer      │  │    │  │  - JWT Bearer      │  │
│  └────────────────────┘  │    │  └────────────────────┘  │    │  └────────────────────┘  │
│  ┌────────────────────┐  │    │  ┌────────────────────┐  │    │  ┌────────────────────┐  │
│  │  Metrics           │  │    │  │  Metrics           │  │    │  │  Metrics           │  │
│  │  /metrics          │  │    │  │  /metrics          │  │    │  │  /metrics          │  │
│  │  (Prometheus)      │  │    │  │  (Prometheus)      │  │    │  │  (Prometheus)      │  │
│  └────────────────────┘  │    │  └────────────────────┘  │    │  └────────────────────┘  │
└────────────┬─────────────┘    └────────────┬─────────────┘    └────────────┬─────────────┘
             │                               │                               │
             └───────────────────────────────┼───────────────────────────────┘
                                             │
                      ┌──────────────────────┴──────────────────────┐
                      │                                             │
                      ▼                                             ▼
           ┌─────────────────────┐                       ┌─────────────────────┐
           │     PostgreSQL      │                       │     Amazon SQS      │
           │     (RDS Aurora)    │                       │                     │
           │                     │                       │  ┌───────────────┐  │
           │  Multi-AZ           │                       │  │ notifications │  │
           │  Read Replicas      │                       │  │ (standard)    │  │
           │                     │                       │  └───────────────┘  │
           │  - notifications    │                       │  ┌───────────────┐  │
           │  - dead_letter      │                       │  │ high_priority │  │
           │  - tenants          │                       │  │ (FIFO)        │  │
           │  - api_keys         │                       │  └───────────────┘  │
           │  - templates        │                       │  ┌───────────────┐  │
           └─────────────────────┘                       │  │ dlq           │  │
                                                         │  │ (dead letter) │  │
                                                         │  └───────────────┘  │
                                                         └──────────┬──────────┘
                                                                    │
                 ┌──────────────────────────────────────────────────┼──────────────────────────────────────────────────┐
                 │                                                  │                                                  │
                 ▼                                                  ▼                                                  ▼
┌──────────────────────────┐                      ┌──────────────────────────┐                      ┌──────────────────────────┐
│    Worker Pod 1          │                      │    Worker Pod 2          │                      │    Worker Pod N          │
│                          │                      │                          │                      │                          │
│  ┌────────────────────┐  │                      │  ┌────────────────────┐  │                      │  ┌────────────────────┐  │
│  │  SQS Consumer      │  │                      │  │  SQS Consumer      │  │                      │  │  SQS Consumer      │  │
│  │  Long Polling (20s)│  │                      │  │  Long Polling (20s)│  │                      │  │  Long Polling (20s)│  │
│  └────────────────────┘  │                      │  └────────────────────┘  │                      │  └────────────────────┘  │
│  ┌────────────────────┐  │                      │  ┌────────────────────┐  │                      │  ┌────────────────────┐  │
│  │  Worker Pool       │  │                      │  │  Worker Pool       │  │                      │  │  Worker Pool       │  │
│  │  (10 goroutines)   │  │                      │  │  (10 goroutines)   │  │                      │  │  (10 goroutines)   │  │
│  └────────────────────┘  │                      │  └────────────────────┘  │                      │  └────────────────────┘  │
│  ┌────────────────────┐  │                      │  ┌────────────────────┐  │                      │  ┌────────────────────┐  │
│  │  Channel Router    │  │                      │  │  Channel Router    │  │                      │  │  Channel Router    │  │
│  │  ├─ EmailSender    │  │                      │  │  ├─ EmailSender    │  │                      │  │  ├─ EmailSender    │  │
│  │  ├─ SMSSender      │  │                      │  │  ├─ SMSSender      │  │                      │  │  ├─ SMSSender      │  │
│  │  └─ WebhookSender  │  │                      │  │  └─ WebhookSender  │  │                      │  │  └─ WebhookSender  │  │
│  └────────────────────┘  │                      │  └────────────────────┘  │                      │  └────────────────────┘  │
└────────────┬─────────────┘                      └────────────┬─────────────┘                      └────────────┬─────────────┘
             │                                                 │                                                 │
             └─────────────────────────────────────────────────┼─────────────────────────────────────────────────┘
                                                               │
                        ┌──────────────────────────────────────┼──────────────────────────────────────┐
                        │                                      │                                      │
                        ▼                                      ▼                                      ▼
               ┌─────────────────┐                    ┌─────────────────┐                    ┌─────────────────┐
               │    AWS SES      │                    │    Twilio       │                    │   Webhook       │
               │                 │                    │                 │                    │                 │
               │    Email        │                    │    SMS          │                    │    HTTP POST    │
               │    Delivery     │                    │    Delivery     │                    │    + Retry      │
               └─────────────────┘                    └─────────────────┘                    └─────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              SUPPORTING SERVICES                                                    │
│                                                                                                                     │
│   ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐                    │
│   │   ElastiCache   │      │   S3            │      │   Secrets       │      │   Parameter     │                    │
│   │   (Redis)       │      │                 │      │   Manager       │      │   Store         │                    │
│   │                 │      │   - templates/  │      │                 │      │                 │                    │
│   │   - rate limits │      │     email.html  │      │   - DB creds    │      │   - feature     │                    │
│   │   - dedup cache │      │     sms.txt     │      │   - API keys    │      │     flags       │                    │
│   │   - sessions    │      │   - attachments │      │   - Twilio SID  │      │   - config      │                    │
│   └─────────────────┘      └─────────────────┘      └─────────────────┘      └─────────────────┘                    │
│                                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              OBSERVABILITY                                                          │
│                                                                                                                     │
│   ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐                    │
│   │   CloudWatch    │      │   X-Ray         │      │   Prometheus    │      │   Grafana       │                    │
│   │                 │      │                 │      │                 │      │                 │                    │
│   │   - App logs    │      │   - Traces      │      │   - API latency │      │   - Dashboards  │                    │
│   │   - Metrics     │      │   - Service map │      │   - Queue depth │      │   - Alerts      │                    │
│   │   - Alarms      │      │   - Latency     │      │   - Error rate  │      │   - SLOs        │                    │
│   └─────────────────┘      └─────────────────┘      └─────────────────┘      └─────────────────┘                    │
│                                                            │                                                        │
│                                                            ▼                                                        │
│                                                   ┌─────────────────┐                                               │
│                                                   │   PagerDuty     │                                               │
│                                                   │                 │                                               │
│                                                   │   - DLQ alerts  │                                               │
│                                                   │   - Error spike │                                               │
│                                                   │   - SLA breach  │                                               │
│                                                   └─────────────────┘                                               │
│                                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

